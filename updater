//!wrt $BSPEC:{"icn":null,"cpr":"Copyright (C) Windows 96 Team 2023.","dsc":"oobe","frn":"Out-of-box experience","aut":"Windows 96 Team","ver":1,"ssy":"gui"} 

const{WizardBaseApplication:WizardBaseApplication}=w96.app.templates,{Theme:Theme}=w96.ui,installationTypes={lite:{name:"Nitrogen update",zip:"https://raw.githubusercontent.com/happen3/nitrogen-packages/main/patch.zip"},full:{name:"Full Installation",zip:"/system/images/rootfs/rootfs.zip"}};let chosenInstallType;function downloadContent(t,e){return new Promise((n=>{const i=new XMLHttpRequest;i.addEventListener("progress",(t=>e(t))),i.onload=()=>n(i),i.responseType="arraybuffer",i.open("GET",t),i.send()}))}async function extractZIPToRoot(t,e){const n=await JSZip.loadAsync(t),i=Object.keys(n.files);for(var s=0;s<i.length;s++){const t=i[s],c=n.files[t];var a=c.name;if(a.startsWith("/")||(a="/"+a),a.endsWith("/")&&(a=a.substring(0,a.length-1)),e&&e({curFile:s+1,totalFiles:i.length,curPath:a}),console.log("Write c:"+a),c.dir)await FS.mkdir(a);else{var o=await c.async("uint8array"),l=FSUtil.getParentPath(a);await FS.exists(l)||await FS.mkdir(l),await FS.writebin(a,o)}}}class OOBEApplication extends WizardBaseApplication{constructor(){super()}async main(t){await super.main(t);const e=this.findPage("intro");e.titleText="Welcome to Nitrogen Updater",e.graphic="/system/resource/app/oobe/graphic.png",e.body="This wizard will help you update Nitrogen quickly and efficiently.<br><br>\n        <br><br>This should take less than a minute to configure, depending on your internet connection and package size.",e.buttons[1].onclick=()=>this.openPage("install-confirm",["lite"]),this.pages.push({id:"install-type",type:"page",body:`Select an installation type:\n                <br>\n                <div class="icon-opt-select">\n                    <div class="option full">\n                        <button style="background-image: url(${await Theme.getIconUrl("devices/hdd","32x32")})" class="w96-button btn"></button>\n                        <div class="text">\n                            <span class="title bold-noaa">Full Install</span>\n                            <span class="explanation">Full installation - will install the full Windows 96 environment with all of its system applications.</span>\n                        </div>\n                    </div>\n\n                    <div class="option lite">\n                        <button style="background-image: url(${await Theme.getIconUrl("devices/floppy","32x32")}); filter: grayscale(1);" class="w96-button btn"></button>\n                        <div class="text">\n                            <span class="title bold-noaa">Lightweight Install</span>\n                            <span class="explanation">Minimal installation size - only the essential applications/data to get you started.</span>\n                        </div>\n                    </div>\n                </div>`,graphic:"/system/resource/app/oobe/graphic-top.png",titleText:"Select an installation type",description:"Choose how you want to install your new operating system.",buttons:[{class:"back",onclick:()=>this.openPage("intro",[]),enabled:!0,text:"Back"},{class:"next",onclick:()=>{},enabled:!1,text:"Next"},{class:"cancel",onclick:()=>this.quit(),enabled:!0,text:"Cancel"}],onopen:(t,e)=>{t.querySelector(".option.lite>button").addEventListener("click",(()=>{this.openPage("install-confirm",["lite"])})),t.querySelector(".option.full>button").addEventListener("click",(()=>{this.openPage("install-confirm",["full"])}))}}),this.pages.push({id:"install-confirm",type:"page",body:'\n                <div>\n                    <span style="display: none;">Installation Type: <span class="install-type"></span></span>\n                    To begin the update, press the next button.<br><br>\n                    Please note that this may take time depending on your update size.<br><br>\n                    Do not shut down during this process - you will likely end up with a corrupted installation!\n                </div>\n            ',graphic:"/system/resource/app/oobe/graphic-top.png",titleText:"Begin the update",description:"Read the information below carefully.",buttons:[{class:"back",onclick:()=>this.openPage("install-type",[]),enabled:!0,text:"Back"},{class:"next",onclick:()=>{this.openPage("install",[])},enabled:!0,text:"Next"},{class:"cancel",onclick:()=>this.quit(),enabled:!0,text:"Cancel"}],onopen:(t,e)=>{chosenInstallType=installationTypes[e[0]],t.querySelector(".install-type").textContent=chosenInstallType.name}}),this.pages.push({id:"install",type:"page",body:'\n                <div>\n                    Installing update - please wait...<br>\n                    <br>\n                    Current progress: <span class="prog-text"></span>\n                    <div class="w96-progressbar" style="margin-top: 16px;">\n                        <div class="progress" style="width: 0%; animation: none;"></div>\n                    </div>\n                </div>\n            ',graphic:"/system/resource/app/oobe/graphic-top.png",titleText:"Installation",description:"Please wait until the installation has concluded.",buttons:[{class:"back",onclick:()=>{},enabled:!1,text:"Back"},{class:"next",onclick:()=>{},enabled:!1,text:"Next"},{class:"cancel",onclick:()=>this.quit(),enabled:!1,text:"Cancel"}],onopen:async(t,e)=>{const n=t.querySelector(".prog-text"),i=t.querySelector(".progress");let s;n.innerText="Downloading RootFS ZIP...";try{s=await downloadContent(chosenInstallType.zip,(t=>{const e=t.loaded/t.total*50;i.style.width=`${e}%`}))}catch(t){const e=this.findPage("intro");return e.titleText="Installation Failed",e.body="The update was not installed successfully on this system. Check your internet connection, or try again later.<br><br>Press Finish to restart.",e.graphic="/system/resource/app/oobe/graphic.png",e.buttons[1].onclick=()=>this.quit(),e.buttons[1].text="Finish",e.buttons[2].enabled=!1,this.openPage("intro",[]),void(this.mainwnd.getBodyContainer().querySelector(".explain").textContent="Click Finish to exit.")}n.innerText="Extracting RootFS to disk...",console.log(s.response),await extractZIPToRoot(s.response,(t=>{n.innerText=`Writing ${t.curPath}`,i.style.width=50+t.curFile/t.totalFiles*50+"%"})),console.log("Deleting stage file...");let a=["c:/.gitkeep","c:/system/local/bin/uinit_stage3","c:/system/local/bin/oobe","c:/system/local/bin/v2mig"];for(let t of a)await FS.exists(t)&&await FS.rm(t);const o=this.findPage("intro");o.titleText="Installation Complete",o.body="The installation for Windows 96 has completed successfully.<br><br>Press Finish to restart.",o.buttons[1].onclick=async()=>{await FS.writestr("C:/system/etc/inststate.json",JSON.stringify({rootfs:chosenInstallType.zip,version:await w96.sys.rel.getVersionString(),installDate:(new Date).toUTCString()},null,4)),w96.sys.reboot()},o.buttons[1].text="Finish",o.buttons[2].enabled=!1,this.openPage("intro",[]),this.mainwnd.getBodyContainer().querySelector(".explain").textContent="Click Finish to exit."}}),this.openPage("intro",[]),this.mainwnd.setTitle("Windows 96 Installer"),this.mainwnd.setControlBoxStyle("WS_CBX_NONE"),this.mainwnd.setWindowIcon(await Theme.getIconUrl("misc/logo","16x16")),this.mainwnd.center()}}

return await WApplication.execAsync(new OOBEApplication(), this.boxedEnv.args, this);